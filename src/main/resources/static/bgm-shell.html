<!doctype html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BGM Shell</title>
  <style>
    html, body { margin:0; height:100%; overflow:hidden; }
    iframe.app-frame {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  border: 0;
  transform: scale(1);
  transform-origin: top left;
  zoom: 1; /* 有些瀏覽器或 Render 預覽頁需要這行 */
}

    /* 一次性全螢幕遮罩（每次載入都會顯示，點一下或按鈕解鎖） */
    #overlay {
      position: fixed; inset: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      display: flex; align-items: center; justify-content: center;
    }
    #overlay-card {
      width: min(92vw, 560px);
      background: rgba(0,0,0,0.72);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 20px 22px;
      color: #fff;
      font-family: system-ui,"Noto Sans TC",sans-serif;
      box-shadow: 0 12px 40px rgba(0,0,0,0.5);
    }
    #overlay h1 {
      margin: 0 0 10px; font-size: 22px; font-weight: 700;
    }
    #overlay p {
      margin: 6px 0 14px; line-height: 1.5; color: #eaeaea;
      font-size: 14px;
    }
    .overlay-actions {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 8px;
    }
    .btn {
      appearance: none; border: 0; border-radius: 10px;
      padding: 12px 14px; font-size: 15px; font-weight: 700;
      cursor: pointer; transition: transform .06s ease, opacity .2s ease;
    }
    .btn:active { transform: translateY(1px) scale(0.99); }
    .btn-primary { background: #3b82f6; color: #fff; }
    .btn-secondary { background: #374151; color: #fff; }
    .row {
      display:flex; align-items:center; gap:10px; flex-wrap: wrap;
    }
    .hint {
      font-size: 12px; color: #cfd7ff; opacity: .9;
      display:flex; align-items:center; gap:8px;
    }
    .hint input[type="checkbox"] { width: 16px; height: 16px; }
    .divider {
      height: 1px; background: rgba(255,255,255,0.08); margin: 12px 0;
    }
    @media (min-width: 520px) {
      .overlay-actions { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <!-- 背景音樂在外殼：換頁不中斷 -->
  <audio id="bgm" src="/audio/bgm_main.mp3" preload="auto" loop playsinline></audio>

  <!-- 內頁：不寫死 src，開機用 JS 還原到上次內頁或預設 /index -->
  <iframe class="app-frame" name="app" allow="autoplay"></iframe>

  <!-- 遮罩：每次載入都會顯示，選擇是否播放 BGM；並建議全螢幕 -->
  <div id="overlay">
    <div id="overlay-card">
      <h1>進入遊戲</h1>
      <p>為符合瀏覽器規範，需要你的操作來決定是否播放背景音樂（BGM）。</p>

      <div class="hint">
        <label class="row">
          <input id="fs-check" type="checkbox"/>
          <span>建議全螢幕遊玩（勾選後進入時會嘗試進入全螢幕）</span>
        </label>
      </div>

      <div class="divider"></div>

      <div class="overlay-actions">
        <button id="btn-play" class="btn btn-primary">開始並播放 BGM</button>
        <button id="btn-noplay" class="btn btn-secondary">不播放 BGM 進入</button>
      </div>

      <p style="margin-top:10px;font-size:12px;opacity:.85">
        小撇步：若沒有成功全螢幕，可按 F11（Windows/Linux）或 Ctrl + ⌘ + F（macOS）。
      </p>
    </div>
  </div>

  <script>
    (function fixHiDPIScale() {
  const ratio = window.devicePixelRatio || 1;
  if (ratio > 1.05) {
    document.body.style.transform = `scale(${ratio})`;
    document.body.style.transformOrigin = "top left";
    document.body.style.width = `${100 / ratio}%`;
    document.body.style.height = `${100 / ratio}%`;
  }
})();
  (function(){
    // ===== 常數與節點 =====
    const audio   = document.getElementById('bgm');
    const overlay = document.getElementById('overlay');
    const iframe  = document.querySelector('iframe.app-frame');
    const btnPlay = document.getElementById('btn-play');
    const btnNo   = document.getElementById('btn-noplay');
    const fsCheck = document.getElementById('fs-check');

    const KEY_VOL   = 'bgm_volume';            // 記憶音量（0~100）
    const KEY_URL   = 'app:lastUrl';           // 內頁最後 URL
    const KEY_NOBGM = 'app:no_bgm_session';    // 本階段是否選擇不播放 BGM（僅本次瀏覽器分頁）

    const DEFAULT_URL = '/index';

    // ===== A. 初始化：還原內頁 URL（避免外殼硬刷新回首頁）=====
    function getRestoreUrl() {
      if (location.hash && location.hash.length > 1) {
        return decodeURIComponent(location.hash.slice(1));
      }
      const saved = sessionStorage.getItem(KEY_URL);
      return saved || DEFAULT_URL;
    }
    iframe.src = getRestoreUrl();

    iframe.addEventListener('load', () => {
      try {
        const w = iframe.contentWindow;
        const url = w.location.pathname + w.location.search + w.location.hash;
        sessionStorage.setItem(KEY_URL, url);
        const newHash = '#'+encodeURIComponent(url);
        if (location.hash !== newHash) {
          history.replaceState(null, '', newHash);
        }
      } catch (e) {
        console.warn('[shell] cannot read iframe URL:', e);
      }
    });

    window.addEventListener('hashchange', () => {
      const to = getRestoreUrl();
      if (!to) return;
      if (iframe.contentWindow) {
        iframe.contentWindow.location.replace(to);
      } else {
        iframe.src = to;
      }
    });

    // ===== B. 音量記憶：避免被記成 0 導致「有播放但沒聲音」 =====
    if (Number(localStorage.getItem(KEY_VOL)) <= 0) {
      localStorage.setItem(KEY_VOL, '60');
    }

    function readTargetVolume() {
      const sv = Number(localStorage.getItem(KEY_VOL));
      if (Number.isNaN(sv) || sv <= 0) {
        localStorage.setItem(KEY_VOL, '60');
        return 0.6;
      }
      return Math.max(0.05, Math.min(1, sv / 100));
    }

    // 還原目前音量
    (function restoreVolume(){
      audio.volume = readTargetVolume();
    })();

    // ===== C. 輔助：全螢幕 =====
    async function goFullscreenIfChecked() {
      if (!fsCheck.checked) return;
      const el = document.documentElement;
      if (el.requestFullscreen) {
        try { await el.requestFullscreen(); } catch(e) { /* 某些瀏覽器或被阻擋時忽略 */ }
      }
    }

    // ===== D. BGM 播放與淡入 =====
    async function startBGM() {
      try {
        audio.muted = false;
        const targetVol = readTargetVolume();

        const startVol = 0;
        audio.volume = startVol;
        await audio.play(); // 需要使用者手勢

        // 淡入
        let v = startVol;
        const t = setInterval(()=>{
          v += 0.05;
          audio.volume = Math.min(targetVol, v);
          if (v >= targetVol) clearInterval(t);
        }, 60);
        return true;
      } catch (e) {
        console.warn('[shell] play failed:', e);
        return false;
      }
    }

    // ===== E. 遮罩按鈕事件：有 / 沒有 BGM =====
    btnPlay.addEventListener('click', async () => {
      sessionStorage.removeItem(KEY_NOBGM); // 明確解除「不播放」
      await goFullscreenIfChecked();
      const ok = await startBGM();
      if (ok) overlay.remove();
      else overlay.remove(); // 即使失敗也讓使用者進入（可能瀏覽器阻擋，之後內頁可再觸發）
    });

    btnNo.addEventListener('click', async () => {
  // 等同於音量歸零
  audio.volume = 0;
  localStorage.setItem(KEY_VOL, '0'); // 記住 0，下次齒輪打開就是靜音狀態
  try { audio.pause(); } catch {}
  audio.muted = false; // 保持 false，避免用戶調回音量卻沒聲音
  await goFullscreenIfChecked();
  overlay.remove();
});


    // ===== F. 從子頁控制（齒輪音量面板）=====
    // 子頁以 postMessage 傳遞控制指令：bgm:setVolume / bgm:play / bgm:pause
    window.addEventListener('message', (ev)=>{
      const msg = ev && ev.data;
      if (!msg || typeof msg !== 'object') return;

      // 若使用者選了「不播放 BGM」，仍允許之後在內頁點擊自己的按鈕觸發播放
      const noBgmNow = sessionStorage.getItem(KEY_NOBGM) === '1';

      if (msg.type === 'bgm:setVolume') {
        const v = Math.max(0, Math.min(1, Number(msg.value)));
        if (!Number.isNaN(v)) {
          audio.volume = v;
          localStorage.setItem(KEY_VOL, String(Math.round(v * 100)));
        }
      } else if (msg.type === 'bgm:play') {
        audio.muted = false;
        // 如果之前選了不播，內頁仍可在使用者的互動下請求播放
        audio.play().catch(()=>{});
      } else if (msg.type === 'bgm:pause') {
        audio.pause();
      }
    });

    // ===== G. 鍵盤刷新只重載內頁（外殼不動，音樂不中斷）=====
    window.addEventListener('keydown', (e) => {
      const isF5    = e.key === 'F5';
      const isCtrlR = e.ctrlKey && (e.key === 'r' || e.key === 'R');
      const isMetaR = e.metaKey && (e.key === 'r' || e.key === 'R'); // macOS
      if (isF5 || isCtrlR || isMetaR) {
        e.preventDefault();
        if (iframe.contentWindow) iframe.contentWindow.location.reload();
      }
    });
  })();
  </script>
</body>
</html>
